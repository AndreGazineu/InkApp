<!DOCTYPE html> 
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ColorApp - M√≥dulo de Tintas</title>
  <link rel="icon" type="image/png" href="https://andregazineu.github.io/colorapp/public/favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="https://andregazineu.github.io/colorapp/src/css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    .main-container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
    }

    .tinta-inspector-layout {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 25px;
      width: 100%;
    }
    .tinta-color-displays {
      display: flex;
      justify-content: center;
      gap: 30px;
      width: 100%;
      flex-wrap: wrap;
    }
    .tinta-color-box {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    .tinta-color-box canvas {
      width: 180px;
      height: 180px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .tinta-color-box span {
      font-weight: 600;
      color: var(--text-dark);
      font-size: 1rem;
    }
    .tinta-inputs {
      display: flex;
      gap: 10px;
      justify-content: center;
      width: 100%;
      max-width: 500px;
    }
    .tinta-inputs input {
      text-align: center;
    }

    .results {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 100%;
    }
    .match {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 14px;
      border-radius: 10px;
      background: var(--card-bg, #111827);
      border: 1px solid var(--border-color, #374151);
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.1s ease;
    }
    .match:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.25);
      background: rgba(37, 99, 235, 0.15);
    }
    .match span {
      font-weight: 500;
      font-size: 0.9rem;
      color: var(--text-light, #f9fafb);
      margin-right: 12px;
      flex: 1;
      word-break: break-word;
    }
    .match .color-sample {
      width: 34px;
      height: 34px;
      border-radius: 8px;
      flex-shrink: 0;
      border: 1px solid rgba(0,0,0,0.2);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .tinta-result-card {
      animation: fadeIn 0.5s ease-out;
      margin-top: 20px;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      border: 1px solid;
      width: 100%;
      max-width: 600px;
    }
    .tinta-result-card.aprovado {
      background-color: #e8f5e9;
      border-color: var(--success);
    }
    .tinta-result-card.reprovado {
      background-color: #ffebee;
      border-color: var(--danger);
    }
    .tinta-result-header {
      font-size: 1.8rem;
      font-weight: 700;
      margin: 0 0 10px 0;
    }
    .tinta-result-header.aprovado { color: var(--success); }
    .tinta-result-header.reprovado { color: var(--danger); }
    .tinta-result-details {
      font-family: var(--font-mono);
      font-size: 1.1rem;
      color: var(--text-dark);
    }

    button {
      cursor: pointer;
    }

    @media (max-width: 768px) {
      .nav-tabs {
        flex-wrap: wrap;
        gap: 6px;
      }
      .nav-tab {
        flex: 1 1 calc(50% - 6px);
        text-align: center;
      }
      .tinta-color-displays {
        flex-direction: column;
        align-items: center;
        gap: 20px;
      }
      .tinta-inputs {
        flex-direction: column;
        max-width: 100%;
      }
      .tinta-inputs input {
        width: 100%;
      }
      .inspector button,
      #tinta-inspect-tab button,
      #tinta-register-tab button,
      #tinta-history-tab button,
      #deltacalculator-tab button {
        width: 100%;
      }
      .match {
        padding: 10px 12px;
      }
      .match span {
        font-size: 0.85rem;
      }
      .main-container {
        padding: 10px;
      }
    }
  </style>
</head>
<body>
  <button class="back-button-fixed" id="fixedbackbutton" style="display:none;" onclick="tinta_goback()">‚¨Ö Voltar</button>
  
  <div class="main-container">
    <div class="nav-tabs">
      <div class="nav-tab active" onclick="showTab('tinta-inspect')">Inspecionar Tinta</div>
      <div class="nav-tab" onclick="showTab('tinta-register')">Cadastrar Tinta</div>
      <div class="nav-tab" onclick="showTab('tinta-history')">Hist√≥rico de Tintas</div>
      <div class="nav-tab" onclick="showTab('deltacalculator')">Diagn√≥stico de Cor</div>
    </div>

    <div id="tinta-inspect-tab" class="tab-content active">
      <h1>Inspecionar Padr√£o de Tinta</h1>
      <div class="input-group">
        <label for="tinta_cad_code">C√≥digo CAD da Tinta:</label>
        <input type="text" id="tinta_cad_code" placeholder="Digite o c√≥digo num√©rico da tinta...">
      </div>
      <button onclick="searchPaintStandards()">Pesquisar Padr√£o</button>
      
      <div class="results" id="tinta_results"></div>
      
      <div class="inspector" id="tinta_inspector" style="display:none;">
        <div class="tinta-inspector-layout">
            <div class="tinta-color-displays">
                <div class="tinta-color-box">
                    <canvas id="tinta_canvas_ref"></canvas>
                    <span id="tinta_standard_name">Padr√£o</span>
                </div>
                <div class="tinta-color-box">
                    <canvas id="tinta_canvas_sample"></canvas>
                    <span>Amostra Medida</span>
                </div>
            </div>
            <div class="tinta-inputs">
                <input type="number" id="tinta_lab_l" placeholder="Valor L*" oninput="updatePaintSampleCanvas()">
                <input type="number" id="tinta_lab_a" placeholder="Valor a*" oninput="updatePaintSampleCanvas()">
                <input type="number" id="tinta_lab_b" placeholder="Valor b*" oninput="updatePaintSampleCanvas()">
            </div>
            <button onclick="inspectPaint()">Verificar e Salvar Inspe√ß√£o</button>
            <div id="tinta_result_area"></div>
            <button id="tinta_diagnostico_btn" class="btn-secondary" onclick="analyzeCurrentPaintInspection()" style="display: none; margin-top: 15px;">Analisar Diagn√≥stico</button>
            <div class="back-button" onclick="tinta_goback()">Voltar para Pesquisa</div>
        </div>
      </div>
    </div>

    <div id="tinta-register-tab" class="tab-content">
        <h1>Cadastrar Novo Padr√£o de Tinta</h1>
        <div class="input-group">
            <label for="new_tinta_cad_code">C√≥digo CAD da Tinta:</label>
            <input type="text" id="new_tinta_cad_code" placeholder="Ex: 1426">
        </div>
        <div class="input-group">
            <label for="new_tinta_l">Valor L*:</label>
            <input type="number" id="new_tinta_l" placeholder="0-100" oninput="updateNewPaintPreview()">
        </div>
        <div class="input-group">
            <label for="new_tinta_a">Valor a*:</label>
            <input type="number" id="new_tinta_a" placeholder="-128 a 127" oninput="updateNewPaintPreview()">
        </div>
        <div class="input-group">
            <label for="new_tinta_b">Valor b*:</label>
            <input type="number" id="new_tinta_b" placeholder="-128 a 127" oninput="updateNewPaintPreview()">
        </div>
        <div class="color-preview">
            <div class="input-group">
                <label>Pr√©via da Cor:</label>
                <div id="new_tinta_preview" class="color-sample" style="margin: 10px 0;"></div>
            </div>
        </div>
        <button onclick="registerNewPaint()">Cadastrar Padr√£o de Tinta</button>
        <div id="tinta_register_message" class="result-message"></div>
        
        <div id="tinta_list">
            <h2>Padr√µes de Tinta Cadastrados</h2>
            <div class="table-container">
                <table id="tinta_standards_table">
                    <thead>
                        <tr><th>C√≥digo CAD</th><th>L*</th><th>a*</th><th>b*</th><th>Cor</th><th>A√ß√µes</th></tr>
                    </thead>
                    <tbody id="tinta_standards_body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tinta-history-tab" class="tab-content">
        <h1>Hist√≥rico de Inspe√ß√µes de Tinta</h1>
        <div class="search-controls">
            <div class="input-group">
                <label for="tinta_history_search">Pesquisar por C√≥digo CAD:</label>
                <input type="text" id="tinta_history_search" placeholder="Digite o c√≥digo...">
            </div>
            <button onclick="searchPaintInspections()">Pesquisar</button>
            <button class="btn-secondary" onclick="clearPaintHistoryFilter()">Limpar / Mostrar Todos</button>
        </div>
        <div class="table-container">
            <table id="tinta_history_table">
                <thead>
                    <tr>
                        <th>C√≥digo CAD</th><th>L* Padr√£o</th><th>a* Padr√£o</th><th>b* Padr√£o</th>
                        <th>L* Medido</th><th>a* Medido</th><th>b* Medido</th>
                        <th>ŒîE2000</th><th>Status</th><th>Data/Hora</th>
                    </tr>
                </thead>
                <tbody id="tinta_history_body"></tbody>
            </table>
        </div>
    </div>

    <div id="deltacalculator-tab" class="tab-content">
        <h1>Ferramenta de Diagn√≥stico de Cor</h1>
        <div class="calculator-layout">
          <div class="inputs-wrapper">
            <div class="color-column">
              <div class="color-header">
                <div class="preview-box" id="preview-padrao"></div>
                <span class="title">Padr√£o (Alvo)</span>
              </div>
              <div class="lab-input-group">
                <label for="l1_diag">L*</label>
                <input id="l1_diag" type="number" value="35" step="0.1" oninput="updateDiagnosticPreviews()">
              </div>
              <div class="lab-input-group">
                <label for="a1_diag">a*</label>
                <input id="a1_diag" type="number" value="100" step="0.1" oninput="updateDiagnosticPreviews()">
              </div>
              <div class="lab-input-group">
                <label for="b1_diag">b*</label>
                <input id="b1_diag" type="number" value="80" step="0.1" oninput="updateDiagnosticPreviews()">
              </div>
            </div>
            <div class="color-column">
              <div class="color-header">
                <div class="preview-box" id="preview-amostra"></div>
                <span class="title">Amostra (Medida)</span>
              </div>
              <div class="lab-input-group">
                <label for="l2_diag">L*</label>
                <input id="l2_diag" type="number" value="80" step="0.1" oninput="updateDiagnosticPreviews()">
              </div>
              <div class="lab-input-group">
                <label for="a2_diag">a*</label>
                <input id="a2_diag" type="number" value="30" step="0.1" oninput="updateDiagnosticPreviews()">
              </div>
              <div class="lab-input-group">
                <label for="b2_diag">b*</label>
                <input id="b2_diag" type="number" value="40" step="0.1" oninput="updateDiagnosticPreviews()">
              </div>
            </div>
            <button onclick="runColorDiagnostic()">Analisar Varia√ß√£o e Gerar Diagn√≥stico</button>
          </div>
          <div class="chart-container-wrapper">
            <div id="chart-container">
              <canvas id="lchChart"></canvas>
            </div>
          </div>
        </div>
        <div id="diagnostico-container">
          <h2>An√°lise da Varia√ß√£o</h2>
          <div class="diagnostico-content">
            <div id="delta-info" class="delta-info"></div>
            <div id="diagnostico-texto" class="diagnostico-texto"></div>
          </div>
        </div>
    </div>
  </div>

  <script defer>
    const supabaseUrl = 'https://cugfezglvaclawbhtola.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN1Z2ZlemdsdmFjbGF3Ymh0b2xhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI0NzM0OTEsImV4cCI6MjA1ODA0OTQ5MX0.3gT5tWcu1fboof_qWWtu-05QhCoiVdTccLirTIPbUTk';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    let paintStandardsDb = [];
    let allPaintInspections = [];
    let selectedPaintStandard = null;
    let diagnosticChartInstance = null;
    const DIAGNOSTIC_TOLERANCE = 0.5;
    let editingPaintId = null;

    function drawColorOnCanvas(canvasId, lab, title) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const { l, a, b } = lab;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = `lab(${l}% ${a} ${b})`;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = l > 55 ? '#000000' : '#FFFFFF';
        ctx.font = "bold 16px 'Poppins', sans-serif";
        ctx.textAlign = 'center';
        ctx.fillText(title, canvas.width / 2, 30);
        ctx.font = "14px 'JetBrains Mono', monospace";
        ctx.fillText(`L*: ${l.toFixed(2)}`, canvas.width / 2, canvas.height / 2);
        ctx.fillText(`a*: ${a.toFixed(2)}`, canvas.width / 2, canvas.height / 2 + 20);
        ctx.fillText(`b*: ${b.toFixed(2)}`, canvas.width / 2, canvas.height / 2 + 40);
    }

    async function loadPaintStandards() {
        try {
            const { data, error } = await supabase.from("paint_standards").select("*").order('cad_code');
            if (error) throw error;
            paintStandardsDb = data || [];
            updatePaintStandardsTable();
        } catch (e) {
            alert("Erro ao carregar padr√µes de tinta: " + e.message);
        }
    }

    function searchPaintStandards() {
        const searchTerm = document.getElementById("tinta_cad_code").value.trim();
        const resultsDiv = document.getElementById("tinta_results");
        resultsDiv.innerHTML = "";
        resultsDiv.style.display = "flex";
        document.getElementById("tinta_inspector").style.display = "none";
        document.getElementById("fixedbackbutton").style.display = "none";
        let matches;
        if (!searchTerm) {
            matches = paintStandardsDb.slice();
        } else {
            matches = paintStandardsDb.filter(p => p.cad_code.toLowerCase().includes(searchTerm.toLowerCase()));
        }
        if (!matches || matches.length === 0) {
            resultsDiv.innerHTML = "Nenhum padr√£o de tinta encontrado.";
            return;
        }
        matches.forEach(match => {
            const matchdiv = document.createElement("div");
            matchdiv.classList.add("match");
            matchdiv.innerHTML = `<span>CAD: ${match.cad_code}</span><div class="color-sample" style="background-color: lab(${match.l}% ${match.a} ${match.b});"></div>`;
            matchdiv.onclick = () => selectPaintStandard(match);
            resultsDiv.appendChild(matchdiv);
        });
    }

    function selectPaintStandard(standard) {
        selectedPaintStandard = standard;
        document.getElementById("tinta_results").style.display = "none";
        document.getElementById("tinta_inspector").style.display = "flex";
        document.getElementById("fixedbackbutton").style.display = "block";
        document.getElementById("tinta_diagnostico_btn").style.display = "none";
        document.getElementById("tinta_lab_l").value = "";
        document.getElementById("tinta_lab_a").value = "";
        document.getElementById("tinta_lab_b").value = "";
        document.getElementById("tinta_result_area").innerHTML = "";
        document.getElementById("tinta_standard_name").textContent = `Padr√£o CAD: ${standard.cad_code}`;
        drawColorOnCanvas('tinta_canvas_ref', { l: standard.l, a: standard.a, b: standard.b }, `CAD: ${standard.cad_code}`);
        drawColorOnCanvas('tinta_canvas_sample', { l: 80, a: 0, b: 0 }, 'Amostra');
    }

    function updatePaintSampleCanvas() {
        const l = parseFloat(document.getElementById("tinta_lab_l").value) || 80;
        const a = parseFloat(document.getElementById("tinta_lab_a").value) || 0;
        const b = parseFloat(document.getElementById("tinta_lab_b").value) || 0;
        drawColorOnCanvas('tinta_canvas_sample', { l, a, b }, 'Amostra');
    }

    async function inspectPaint() {
        if (!selectedPaintStandard) {
            alert("Nenhum padr√£o de tinta selecionado!");
            return;
        }
        const l2 = parseFloat(document.getElementById("tinta_lab_l").value);
        const a2 = parseFloat(document.getElementById("tinta_lab_a").value);
        const b2 = parseFloat(document.getElementById("tinta_lab_b").value);
        if (isNaN(l2) || isNaN(a2) || isNaN(b2)) {
            alert("Valores L*, a*, b* medidos s√£o inv√°lidos.");
            return;
        }
        const deltaE = ciede2000(selectedPaintStandard.l, selectedPaintStandard.a, selectedPaintStandard.b, l2, a2, b2);
        const status = deltaE <= 2.0 ? "Aprovado" : "Reprovado";
        const statusClass = status.toLowerCase();
        const resultArea = document.getElementById("tinta_result_area");
        resultArea.innerHTML = `
            <div class="tinta-result-card ${statusClass}">
                <h3 class="tinta-result-header ${statusClass}">${status.toUpperCase()}</h3>
                <div class="tinta-result-details">
                    Diferen√ßa de Cor (ŒîE2000): <strong>${deltaE.toFixed(2)}</strong>
                </div>
            </div>
        `;
        try {
            const { error } = await supabase.from("paint_inspections").insert([{
                cad_code: selectedPaintStandard.cad_code,
                standard_l: selectedPaintStandard.l, standard_a: selectedPaintStandard.a, standard_b: selectedPaintStandard.b,
                inspected_l: l2, inspected_a: a2, inspected_b: b2,
                delta_e: parseFloat(deltaE.toFixed(2)), status: status
            }]);
            if (error) throw error;
            resultArea.querySelector('.tinta-result-details').innerHTML += '<br><span style="color:var(--success); font-size:0.9em;">Inspe√ß√£o salva com sucesso!</span>';
        } catch (e) {
            alert("Erro ao salvar inspe√ß√£o de tinta: " + e.message);
        }
        document.getElementById("tinta_diagnostico_btn").style.display = "block";
    }

    function tinta_goback() {
        document.getElementById("tinta_inspector").style.display = "none";
        document.getElementById("tinta_results").style.display = "flex";
        document.getElementById("fixedbackbutton").style.display = "none";
        selectedPaintStandard = null;
    }

    async function registerNewPaint() {
        const cad_code = document.getElementById("new_tinta_cad_code").value.trim();
        const l = parseFloat(document.getElementById("new_tinta_l").value);
        const a = parseFloat(document.getElementById("new_tinta_a").value);
        const b = parseFloat(document.getElementById("new_tinta_b").value);
        const messageDiv = document.getElementById("tinta_register_message");
        if (!cad_code || isNaN(l) || isNaN(a) || isNaN(b)) {
            messageDiv.textContent = "Dados inv√°lidos. Preencha todos os campos corretamente.";
            messageDiv.style.color = "var(--danger)";
            return;
        }
        try {
            if (editingPaintId) {
                const { error } = await supabase.from("paint_standards").update({ cad_code, l, a, b }).eq("id", editingPaintId);
                if (error) throw error;
                messageDiv.textContent = "Padr√£o de tinta atualizado com sucesso!";
                messageDiv.style.color = "var(--success)";
            } else {
                const { error } = await supabase.from("paint_standards").insert([{ cad_code, l, a, b }]);
                if (error) throw error;
                messageDiv.textContent = "Padr√£o de tinta cadastrado com sucesso!";
                messageDiv.style.color = "var(--success)";
            }
            document.getElementById("new_tinta_cad_code").value = "";
            document.getElementById("new_tinta_l").value = "";
            document.getElementById("new_tinta_a").value = "";
            document.getElementById("new_tinta_b").value = "";
            editingPaintId = null;
            updateNewPaintPreview();
            await loadPaintStandards();
        } catch (e) {
            messageDiv.textContent = "Erro ao salvar padr√£o: " + e.message;
            messageDiv.style.color = "var(--danger)";
        }
    }
    
    function updateNewPaintPreview() {
        const l = parseFloat(document.getElementById("new_tinta_l").value) || 80;
        const a = parseFloat(document.getElementById("new_tinta_a").value) || 0;
        const b = parseFloat(document.getElementById("new_tinta_b").value) || 0;
        updateColorSample(document.getElementById("new_tinta_preview"), l, a, b);
    }

    function updatePaintStandardsTable() {
        const tableBody = document.getElementById("tinta_standards_body");
        tableBody.innerHTML = "";
        if (paintStandardsDb.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">Nenhum padr√£o cadastrado.</td></tr>`;
            return;
        }
        paintStandardsDb.forEach(p => {
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td>${p.cad_code}</td>
                <td>${p.l.toFixed(2)}</td>
                <td>${p.a.toFixed(2)}</td>
                <td>${p.b.toFixed(2)}</td>
                <td><div class="color-sample" style="background-color: lab(${p.l}% ${p.a} ${p.b});"></div></td>
                <td>
                    <button class="btn-secondary btn-small" onclick="editPaintStandard(${p.id})">Alterar</button>
                    <button class="btn-danger btn-small" onclick="deletePaintStandard(${p.id})">Remover</button>
                </td>
            `;
        });
    }

    function editPaintStandard(id) {
        const standard = paintStandardsDb.find(p => p.id === id);
        if (!standard) {
            alert("Padr√£o de tinta n√£o encontrado para edi√ß√£o.");
            return;
        }
        editingPaintId = id;
        document.getElementById("new_tinta_cad_code").value = standard.cad_code;
        document.getElementById("new_tinta_l").value = standard.l;
        document.getElementById("new_tinta_a").value = standard.a;
        document.getElementById("new_tinta_b").value = standard.b;
        updateNewPaintPreview();
        const messageDiv = document.getElementById("tinta_register_message");
        messageDiv.textContent = `Editando padr√£o existente CAD ${standard.cad_code}. Ao salvar, o registro ser√° atualizado.`;
        messageDiv.style.color = "var(--warning)";
        showTab('tinta-register');
    }

    async function deletePaintStandard(id) {
        if (!confirm("Tem certeza que deseja remover este padr√£o de tinta?")) return;
        try {
            const { error } = await supabase.from("paint_standards").delete().eq("id", id);
            if (error) throw error;
            alert("Padr√£o removido com sucesso!");
            if (editingPaintId === id) {
                editingPaintId = null;
                document.getElementById("new_tinta_cad_code").value = "";
                document.getElementById("new_tinta_l").value = "";
                document.getElementById("new_tinta_a").value = "";
                document.getElementById("new_tinta_b").value = "";
                updateNewPaintPreview();
                document.getElementById("tinta_register_message").textContent = "";
            }
            await loadPaintStandards();
        } catch (e) {
            alert("Erro ao remover padr√£o: " + e.message);
        }
    }

    async function loadPaintInspections() {
        try {
            const { data, error } = await supabase.from("paint_inspections").select("*").order('created_at', { ascending: false });
            if (error) throw error;
            allPaintInspections = data || [];
            updatePaintInspectionsTable(allPaintInspections);
        } catch (e) {
            alert("Erro ao carregar hist√≥rico de tintas: " + e.message);
        }
    }

    function updatePaintInspectionsTable(data) {
        const tableBody = document.getElementById("tinta_history_body");
        tableBody.innerHTML = "";
        if (data.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="10" style="text-align:center;">Nenhuma inspe√ß√£o encontrada.</td></tr>`;
            return;
        }
        data.forEach(item => {
            const statusClass = item.status === 'Aprovado' ? 'status-aprovado' : 'status-reprovado';
            const formattedDate = new Date(item.created_at).toLocaleString("pt-BR", { timeZone: 'America/Sao_Paulo' });
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td>${item.cad_code}</td>
                <td>${item.standard_l.toFixed(2)}</td>
                <td>${item.standard_a.toFixed(2)}</td>
                <td>${item.standard_b.toFixed(2)}</td>
                <td>${item.inspected_l.toFixed(2)}</td>
                <td>${item.inspected_a.toFixed(2)}</td>
                <td>${item.inspected_b.toFixed(2)}</td>
                <td>${item.delta_e}</td>
                <td class="status-cell ${statusClass}">${item.status}</td>
                <td>${formattedDate}</td>
            `;
        });
    }

    function searchPaintInspections() {
        const searchTerm = document.getElementById("tinta_history_search").value.trim().toLowerCase();
        if (!searchTerm) {
            updatePaintInspectionsTable(allPaintInspections);
            return;
        }
        const filteredData = allPaintInspections.filter(item => item.cad_code.toLowerCase().includes(searchTerm));
        updatePaintInspectionsTable(filteredData);
    }

    function clearPaintHistoryFilter() {
        document.getElementById("tinta_history_search").value = "";
        updatePaintInspectionsTable(allPaintInspections);
    }

    function ciede2000(l1, a1, b1, l2, a2, b2) {
        const pi = Math.PI, rad2deg = 180 / pi, deg2rad = pi / 180;
        const c1 = Math.sqrt(a1*a1 + b1*b1), c2 = Math.sqrt(a2*a2 + b2*b2);
        const c1c2 = (c1 + c2) / 2.0, c1c2pow7 = Math.pow(c1c2, 7);
        const g = 0.5 * (1.0 - Math.sqrt(c1c2pow7 / (c1c2pow7 + Math.pow(25, 7))));
        const a1p = (1.0 + g)*a1, a2p = (1.0 + g)*a2;
        const c1p = Math.sqrt(a1p*a1p + b1*b1), c2p = Math.sqrt(a2p*a2p + b2*b2);
        let h1p = Math.atan2(b1, a1p); if (h1p < 0) h1p += 2*pi; h1p *= rad2deg;
        let h2p = Math.atan2(b2, a2p); if (h2p < 0) h2p += 2*pi; h2p *= rad2deg;
        const dlp = l2 - l1, dcp = c2p - c1p;
        let dhp = 0;
        if (c1p * c2p !== 0) {
            dhp = h2p - h1p;
            if (dhp > 180) dhp -= 360;
            else if (dhp < -180) dhp += 360;
        }
        const dhp2 = 2.0 * Math.sqrt(c1p*c2p) * Math.sin((dhp*deg2rad)/2.0);
        const lpmean = (l1 + l2)/2.0, cpmean = (c1p + c2p)/2.0;
        let hmean = 0;
        if (c1p * c2p !== 0) {
            hmean = (h1p + h2p)/2.0;
            if (Math.abs(h1p - h2p) > 180) hmean += 180;
            if (hmean > 360) hmean -= 360;
        }
        const t = 1 - 0.17*Math.cos((hmean - 30)*deg2rad) + 0.24*Math.cos((2*hmean)*deg2rad) + 0.32*Math.cos((3*hmean + 6)*deg2rad) - 0.20*Math.cos((4*hmean - 63)*deg2rad);
        const lpmean_minus_50squared = (lpmean - 50)*(lpmean - 50);
        const sl = 1 + (0.015*lpmean_minus_50squared)/Math.sqrt(20 + lpmean_minus_50squared);
        const sc = 1 + 0.045*cpmean;
        const sh = 1 + 0.015*cpmean*t;
        const dtheta = 30*Math.exp(-Math.pow((hmean - 275)/25, 2));
        const cpmeanPow7 = Math.pow(cpmean, 7);
        const rc = 2*Math.sqrt(cpmeanPow7/(cpmeanPow7 + Math.pow(25, 7)));
        const rt = -rc * Math.sin(2*dtheta*deg2rad);
        const kl = 1, kc = 1, kh = 1;
        const dlpsl = dlp/(kl*sl), dcpsc = dcp/(kc*sc), dhpsh = dhp2/(kh*sh);
        return Math.sqrt(dlpsl*dlpsl + dcpsc*dcpsc + dhpsh*dhpsh + rt*dcpsc*dhpsh);
    }

    function updateColorSample(element, l, a, b) {
        if (!element) return;
        const lVal = Math.max(0, Math.min(100, parseFloat(l) || 0));
        const aVal = parseFloat(a) || 0;
        const bVal = parseFloat(b) || 0;
        element.style.backgroundColor = (!isNaN(lVal) && !isNaN(aVal) && !isNaN(bVal)) ? `lab(${lVal}% ${aVal} ${bVal})` : '#808080';
    }

    function showTab(tabId) {
      document.querySelectorAll(".nav-tab").forEach(tab => tab.classList.remove("active"));
      document.querySelectorAll(".tab-content").forEach(content => content.classList.remove("active"));
      const activeNavTab = Array.from(document.querySelectorAll('.nav-tab')).find(el => el.getAttribute('onclick').includes(`'${tabId}'`));
      const activeTabContent = document.getElementById(tabId + "-tab");
      if (activeNavTab) activeNavTab.classList.add("active");
      if (activeTabContent) activeTabContent.classList.add("active");
      if(tabId === 'tinta-register' && paintStandardsDb.length === 0) {
          loadPaintStandards();
      }
      if(tabId === 'tinta-history' && allPaintInspections.length === 0) {
          loadPaintInspections();
      }
    }

    function analyzeInspectionInDiagnostic(l_orig, a_orig, b_orig, l_insp, a_insp, b_insp) {
      document.getElementById('l1_diag').value = l_orig;
      document.getElementById('a1_diag').value = a_orig;
      document.getElementById('b1_diag').value = b_orig;
      document.getElementById('l2_diag').value = l_insp;
      document.getElementById('a2_diag').value = a_insp;
      document.getElementById('b2_diag').value = b_insp;
      showTab('deltacalculator');
      runColorDiagnostic();
    }

    function analyzeCurrentPaintInspection() {
        if (!selectedPaintStandard) {
            alert("Erro: Nenhuma inspe√ß√£o ativa para analisar.");
            return;
        }
        const l2 = parseFloat(document.getElementById("tinta_lab_l").value);
        const a2 = parseFloat(document.getElementById("tinta_lab_a").value);
        const b2 = parseFloat(document.getElementById("tinta_lab_b").value);
        if (isNaN(l2) || isNaN(a2) || isNaN(b2)) {
            alert("Valores medidos inv√°lidos para diagn√≥stico.");
            return;
        }
        analyzeInspectionInDiagnostic(selectedPaintStandard.l, selectedPaintStandard.a, selectedPaintStandard.b, l2, a2, b2);
    }

    function labToLch(L, a, b) {
      const C = Math.hypot(a, b);
      let h = Math.atan2(b, a) * (180/Math.PI);
      if (h < 0) h += 360;
      return { l: L, c: C, h };
    }

    function getDiagnosticLabFromInput(prefix) {
        return {
            l: parseFloat(document.getElementById(`l${prefix}_diag`).value),
            a: parseFloat(document.getElementById(`a${prefix}_diag`).value),
            b: parseFloat(document.getElementById(`b${prefix}_diag`).value)
        };
    }

    function runColorDiagnostic() {
      const labPadrao = getDiagnosticLabFromInput('1');
      const labAmostra = getDiagnosticLabFromInput('2');
      const lchPadrao = labToLch(labPadrao.l, labPadrao.a, labPadrao.b);
      const lchAmostra = labToLch(labAmostra.l, labAmostra.a, labAmostra.b);
      const dL = lchAmostra.l - lchPadrao.l;
      const da = labAmostra.a - labPadrao.a;
      const db = labAmostra.b - labPadrao.b;
      const dC = lchAmostra.c - lchPadrao.c;
      let dh = lchAmostra.h - lchPadrao.h;
      if (dh > 180) dh -= 360;
      if (dh < -180) dh += 360;
      const dE2000 = ciede2000(labPadrao.l, labPadrao.a, labPadrao.b, labAmostra.l, labAmostra.a, labAmostra.b);
      const diagnostico = { resumo: '', luminosidade: { diagnostico: '', acao: '' }, croma: { diagnostico: '', acao: '' }, matiz: { diagnostico: '', acao: '' } };
      if (dE2000 <= 1.0) {
          diagnostico.resumo = `üéØ <strong>Status: APROVADO.</strong> A diferen√ßa de cor (${dE2000.toFixed(2)}) √© praticamente impercept√≠vel.`;
      } else if (dE2000 <= 2.0) {
          diagnostico.resumo = `‚ö†Ô∏è <strong>Status: APROVA√á√ÉO COM RESSALVAS.</strong> Existe uma pequena diferen√ßa de cor (${dE2000.toFixed(2)}) que pode ser notada por um observador treinado.`;
      } else {
          diagnostico.resumo = `‚ùå <strong>Status: REJEITADO.</strong> A diferen√ßa de cor (${dE2000.toFixed(2)}) √© clara e facilmente percept√≠vel.`;
      }
      if (Math.abs(dL) < DIAGNOSTIC_TOLERANCE) {
          diagnostico.luminosidade.diagnostico = "‚úÖ <strong>Luminosidade (L*):</strong> Correta.";
          diagnostico.luminosidade.acao = "<em>O n√≠vel de claridade/escurid√£o da amostra corresponde ao padr√£o.</em>";
      } else if (dL > 0) {
          diagnostico.luminosidade.diagnostico = `‚¨ÜÔ∏è <strong>Luminosidade (L*):</strong> A amostra est√° <strong>${dL.toFixed(2)}</strong> pontos <strong>MAIS CLARA</strong>. <em>Isso √© indicado por um valor de ŒîL* positivo.</em>`;
          diagnostico.luminosidade.acao = "<strong>A√ß√£o Sugerida:</strong> Para escurecer, aumente a concentra√ß√£o dos pigmentos na formula√ß√£o. Uma alternativa √© adicionar uma quantidade m√≠nima de pigmento preto, mas com cautela, pois isso tamb√©m ir√° reduzir drasticamente a satura√ß√£o (Croma), tornando a cor mais 'suja'.";
      } else {
          diagnostico.luminosidade.diagnostico = `‚¨áÔ∏è <strong>Luminosidade (L*):</strong> A amostra est√° <strong>${Math.abs(dL).toFixed(2)}</strong> pontos <strong>MAIS ESCURA</strong>. <em>Isso √© indicado por um valor de ŒîL* negativo.</em>`;
          diagnostico.luminosidade.acao = "<strong>A√ß√£o Sugerida:</strong> Para clarear, reduza a concentra√ß√£o de pigmentos adicionando mais base ou diluente (extender). Isso diminui a densidade da cor. Adicionar pigmento branco tamb√©m clareia, mas ir√° reduzir a satura√ß√£o (Croma), resultando em um tom mais pastel.";
      }
      if (Math.abs(dC) < DIAGNOSTIC_TOLERANCE) {
          diagnostico.croma.diagnostico = "‚úÖ <strong>Croma (C*):</strong> Correto.";
          diagnostico.croma.acao = "<em>A intensidade ou 'pureza' da cor est√° adequada.</em>";
      } else if (dC > 0) {
          diagnostico.croma.diagnostico = `‚¨ÜÔ∏è <strong>Croma (C*):</strong> A amostra est√° <strong>${dC.toFixed(2)}</strong> pontos <strong>MAIS VIVA / LIMPA</strong>. <em>Isso √© indicado por um ŒîC* positivo, mostrando maior satura√ß√£o.</em>`;
          diagnostico.croma.acao = "<strong>A√ß√£o Sugerida:</strong> Para 'sujar' a cor e reduzir sua intensidade, adicione uma quantidade m√≠nima da sua cor complementar, ou um pigmento de cinza neutro/preto.";
      } else {
          diagnostico.croma.diagnostico = `‚¨áÔ∏è <strong>Croma (C*):</strong> A amostra est√° <strong>${Math.abs(dC).toFixed(2)}</strong> pontos <strong>MAIS SUJA / APAGADA</strong>. <em>Isso √© indicado por um ŒîC* negativo, mostrando menor satura√ß√£o.</em>`;
          diagnostico.croma.acao = "<strong>A√ß√£o Sugerida:</strong> Aumente a concentra√ß√£o do(s) pigmento(s) principal(is) da cor. Verifique tamb√©m a pureza dos componentes; contamina√ß√£o na base ou nos pigmentos pode causar perda de croma.";
      }
      if (Math.abs(dh) < DIAGNOSTIC_TOLERANCE) {
          diagnostico.matiz.diagnostico = "‚úÖ <strong>Matiz (h):</strong> Correto.";
          diagnostico.matiz.acao = "<em>N√£o h√° desvio de tonalidade percept√≠vel.</em>";
      } else {
          let tendencia = "";
          if (Math.abs(da) > Math.abs(db)) {
              tendencia = da > 0 ? "mais avermelhada" : "mais esverdeada";
          } else {
              tendencia = db > 0 ? "mais amarelada" : "mais azulada";
          }
          const correcao = `Para neutralizar o desvio, ajuste a propor√ß√£o dos pigmentos da formula√ß√£o. Identifique o(s) componente(s) que est√°(√£o) causando a tend√™ncia <strong>${tendencia}</strong> e reduza sua concentra√ß√£o, ou reforce o(s) pigmento(s) da dire√ß√£o oposta.`;
          diagnostico.matiz.diagnostico = `üîÑ <strong>Matiz (h):</strong> Desvio de <strong>${dh.toFixed(2)}¬∞</strong>. <em>A tonalidade da amostra est√° ligeiramente <strong>${tendencia}</strong> em rela√ß√£o ao padr√£o.</em>`;
          diagnostico.matiz.acao = `<strong>A√ß√£o Sugerida:</strong> ${correcao}`;
      }
      document.getElementById('delta-info').innerHTML = `<p><strong>Diferen√ßa Total (ŒîE‚ÇÄ‚ÇÄ): ${dE2000.toFixed(2)}</strong></p><p><strong>Deltas LCH:</strong> ŒîL*: ${dL.toFixed(2)}, ŒîC*: ${dC.toFixed(2)}, Œîh: ${dh.toFixed(2)}¬∞</p><p><strong>Deltas LAB:</strong> ŒîL*: ${dL.toFixed(2)}, Œîa*: ${da.toFixed(2)}, Œîb*: ${db.toFixed(2)}</p>`;
      document.getElementById('diagnostico-texto').innerHTML = `<h3>Diagn√≥stico T√©cnico e A√ß√£o Recomendada</h3><p>${diagnostico.resumo}</p><hr style="border:0; border-top:1px solid #eee; margin: 15px 0;"><p>${diagnostico.luminosidade.diagnostico}<br><em>${diagnostico.luminosidade.acao}</em></p><p>${diagnostico.croma.diagnostico}<br><em>${diagnostico.croma.acao}</em></p><p>${diagnostico.matiz.diagnostico}<br><em>${diagnostico.matiz.acao}</em></p>`;
      document.getElementById('diagnostico-container').style.display = 'block';
      plotDiagnosticChart(lchPadrao, lchAmostra, labPadrao, labAmostra);
      updateDiagnosticPreviews();
    }

    function plotDiagnosticChart(lchPadrao, lchAmostra, labPadrao, labAmostra) {
        const labels = Array.from({ length: 360 }, (_, i) => i + '¬∞');
        const toChartAngle = (mathAngle) => (450 - mathAngle) % 360;
        const hPadraoChart = toChartAngle(lchPadrao.h);
        const hAmostraChart = toChartAngle(lchAmostra.h);
        const dataPadrao = new Array(360).fill(null);
        dataPadrao[Math.round(hPadraoChart) % 360] = lchPadrao.c;
        const dataAmostra = new Array(360).fill(null);
        dataAmostra[Math.round(hAmostraChart) % 360] = lchAmostra.c;
        const data = {
            labels: labels,
            datasets: [{
                label: 'Padr√£o', data: dataPadrao, pointBackgroundColor: `lab(${labPadrao.l}% ${labPadrao.a} ${labPadrao.b})`,
                pointBorderColor: '#000', pointRadius: 10, pointHoverRadius: 12, borderColor: 'rgba(0,0,0,0.5)', backgroundColor: 'rgba(0,0,0,0)'
            }, {
                label: 'Amostra', data: dataAmostra, pointBackgroundColor: `lab(${labAmostra.l}% ${labAmostra.a} ${labAmostra.b})`,
                pointBorderColor: '#fff', pointRadius: 8, pointHoverRadius: 10, borderColor: 'rgba(255,0,0,0.5)', backgroundColor: 'rgba(0,0,0,0)'
            }]
        };
        const options = {
            maintainAspectRatio: false,
            scales: { r: { min: 0, max: 140, beginAtZero: true, ticks: { stepSize: 20, backdropColor: 'rgba(255, 255, 255, 0.75)', fontFamily: "'JetBrains Mono', monospace" }, angleLines: { color: 'rgba(0, 0, 0, 0.2)' }, grid: { color: 'rgba(0, 0, 0, 0.2)' }, pointLabels: { display: false } } },
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        font: { family: "'Poppins', sans-serif" },
                        generateLabels: function(chart) {
                            const originalLabels = Chart.defaults.plugins.legend.labels.generateLabels(chart);
                            originalLabels.forEach((label, i) => {
                                const dataset = chart.data.datasets[i];
                                if (dataset && dataset.pointBackgroundColor) {
                                    label.fillStyle = dataset.pointBackgroundColor;
                                    label.strokeStyle = '#333';
                                }
                            });
                            return originalLabels;
                        }
                    }
                },
                tooltip: { callbacks: { label: function(context) { const lch = context.dataset.label === 'Padr√£o' ? lchPadrao : lchAmostra; return `C*: ${lch.c.toFixed(2)}, h: ${lch.h.toFixed(2)}¬∞`; } } }
            }
        };
        if (diagnosticChartInstance) diagnosticChartInstance.destroy();
        const ctx = document.getElementById('lchChart').getContext('2d');
        diagnosticChartInstance = new Chart(ctx, { type: 'radar', data: data, options: options });
    }

    function updateDiagnosticPreviews() {
        const labPadrao = getDiagnosticLabFromInput('1');
        const labAmostra = getDiagnosticLabFromInput('2');
        document.getElementById('preview-padrao').style.backgroundColor = `lab(${labPadrao.l}% ${labPadrao.a} ${labPadrao.b})`;
        document.getElementById('preview-amostra').style.backgroundColor = `lab(${labAmostra.l}% ${labAmostra.a} ${labAmostra.b})`;
    }

    window.onload = async function() {
      await loadPaintStandards();
      showTab("tinta-inspect");
      updateNewPaintPreview();
      updateDiagnosticPreviews();
      runColorDiagnostic();
      searchPaintStandards();
    };
  </script>
</body>
</html>
